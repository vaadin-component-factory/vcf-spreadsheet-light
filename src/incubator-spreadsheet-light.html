<!--
@license
Copyright (c) 2018 Vaadin Ltd.
This program is available under Commercial Vaadin Add-On License 3.0 (CVALv3).

See <a href="https://vaadin.com/license/cval-3">the website</a> for the complete license.
-->

<link rel="import" href="../../polymer/polymer-element.html">
<link rel="import" href="../../vaadin-themable-mixin/vaadin-themable-mixin.html">
<link rel="import" href="../../vaadin-element-mixin/vaadin-element-mixin.html">
<link rel="import" href="../../vaadin-grid/vaadin-grid.html">

<link rel="import" href="incubator-spreadsheet-cell.html">

<dom-module id="incubator-spreadsheet-light">
  <template>
    <style>
    </style>

    <vaadin-grid id="spreadsheet" items="{{_spreadsheetData}}">
      <vaadin-grid-column width="60px" flex-grow="0" text-align="center" id="indexColumn"></vaadin-grid-column>
      <template is="dom-repeat" items="{{_columns}}" as="col">
        <vaadin-grid-column id="[[col.colId]]" header="[[col.title]]" path="[[col.field]]"></vaadin-grid-column>
      </template>
    </vaadin-grid>
  </template>

  <script>
    (function () {
      /**
       * `<incubator-spreadsheet-light>` is a template for incubator components.
       *
       * ```
       * <incubator-spreadsheet-light>
       * </incubator-spreadsheet-light>
       * ```
       *
       * @memberof Vaadin
       * @demo demo/index.html
       */
      class IncubatorSpreadsheetLight extends Vaadin.ElementMixin(Vaadin.ThemableMixin(Polymer.Element)) {
        static get is() {
          return 'incubator-spreadsheet-light';
        }

        static get properties() {
          return {
            _spreadsheetData: {
              type: Array,
              value: []
            },

            _referenceSequence: {
              type: Array,
              computed: '_generateReferenceSequence(10)'
            },

            _minimumRowsToDisplay: {
              type: Number,
              value: 10
            },

            _selectedCell: {
              type: Object,
              // TODO: This should be done more sensibly.
              value: {
                col: 'a',
                row: 1
              }
            }
          };
        }

        static get observers() {
          return [
            '_spreadsheetDataChanged(_spreadsheetData)'
          ];
        }

        ready() {
          super.ready();

          // Assign the variable holding the columns of the grid.
          this._columns = [...this._referenceSequence];

          // Grid should be rendered.
          this._shouldRender = true;

          this.set('_spreadsheetData', this._getEmptySpreadsheetData(this._minimumRowsToDisplay));

          // This should be done with no dependencies to Polymer
          const columns = Polymer.dom(this.root).querySelectorAll('vaadin-grid-column[id^="col-"]');
          columns.forEach(c => {
            c.renderer = (root, column, rowData) => {
              const cell = document.createElement('incubator-spreadsheet-cell');
              cell.setAttribute('col', c.path);
              cell.setAttribute('row', rowData.index + 1);
              cell.setAttribute('value', rowData.item[c.path]);

              cell.addEventListener('incubator-spreadsheet-cell-key-up', (ev) => {
                this._focusCell(ev.detail.col, ev.detail.row - 1);
              });

              cell.addEventListener('incubator-spreadsheet-cell-key-down', (ev) => {
                this._focusCell(ev.detail.col, ev.detail.row + 1);
              });

              cell.addEventListener('incubator-spreadsheet-cell-key-left', (ev) => {
                const colIndex = this._referenceSequence.findIndex((item) => {
                  return item.field === ev.detail.col;
                });

                if (colIndex > 0) {
                  this._focusCell(this._referenceSequence[colIndex - 1].field, ev.detail.row);
                }
              });

              cell.addEventListener('incubator-spreadsheet-cell-key-right', (ev) => {
                const colIndex = this._referenceSequence.findIndex((item) => {
                  return item.field === ev.detail.col;
                });

                if (colIndex + 1 < this._referenceSequence.length) {
                  this._focusCell(this._referenceSequence[colIndex + 1].field, ev.detail.row);
                }
              });

              cell.addEventListener('incubator-spreadsheet-cell-key-return', (ev) => {
                this._focusCell(ev.detail.col, ev.detail.row + 1);
              });

              cell.addEventListener('incubator-spreadsheet-cell-selected', (ev) => {
                this.set('_selectedCell', {
                  col: ev.detail.col,
                  row: ev.detail.row
                });
              });

              cell.addEventListener('incubator-spreadsheet-cell-paste', (ev) => {
                this._pasteFromClipboard();
              })

              while (root.firstChild) {
                root.removeChild(root.firstChild);
              }

              root.append(cell);
            }
          });

          const indexCol = Polymer.dom(this.root).querySelector('vaadin-grid-column#indexColumn');
          indexCol.renderer = (root, column, rowData) => {
            root.textContent = rowData.index + 1;
          }

          // https://stackoverflow.com/questions/2903991/how-to-detect-ctrlv-ctrlc-using-javascript
          let ctrlDown = false;
          const ctrlKey = 17,
            cmdKey = 91,
            vKey = 86;

          document.addEventListener('keydown', (e) => {
            if (e.keyCode == ctrlKey || e.keyCode == cmdKey) {
              ctrlDown = true;
            }

            if (ctrlDown && (e.keyCode == vKey)) {
              this._pasteFromClipboard();
            };
          });
          document.addEventListener('keyup', (e) => {
            if (e.keyCode == ctrlKey || e.keyCode == cmdKey) ctrlDown = false;
          });
        }

        _focusCell(col, row) {
          const cellToSelect = Polymer.dom(this.root).querySelector(
            `incubator-spreadsheet-cell[col="${col}"][row="${row}"]`
          );

          if (cellToSelect) {
            cellToSelect.focus();
          }
        }

        _pasteFromClipboard() {
          // https://stackoverflow.com/questions/6413036/get-current-clipboard-content
          navigator.clipboard.readText()
            .then(text => {
              const lines = text.split('\n');
              const requiredLines = parseInt(this._selectedCell.row) + lines.length;
              const rowsToDisplay = this._minimumRowsToDisplay > requiredLines ? this._minimumRowsToDisplay :
                requiredLines;
              const colIndex = this._referenceSequence.findIndex((item) => {
                return item.field === this._selectedCell.col;
              });

              const newData = this._getEmptySpreadsheetData(rowsToDisplay);
              lines.forEach((line, lineIndex) => {
                const cells = line.split('\t');
                cells.forEach((cell, cellIndex) => {
                  newData[parseInt(this._selectedCell.row) + lineIndex - 1][this._columns[cellIndex +
                    colIndex].field] = cell;
                });
              });

              this.set('_spreadsheetData', newData);
            })
            .catch(err => {
              console.error('Failed to read clipboard contents: ', err);
            });
        }

        _spreadsheetDataChanged(newVal, oldVal) {

        }

        _getEmptyRow() {
          const _emptyRow = {};

          this._columns.forEach(c => {
            _emptyRow[c.field] = '';
          });

          return _emptyRow;
        }

        _getEmptySpreadsheetData(rows) {
          const datum = this._getEmptyRow(),
            data = [];

          // TODO: Make this more suffisticated.
          for (var i = 0, l = rows; i < l; i++) {
            data.push(Object.assign({}, datum));
          }

          return data;
        }

        _generateReferenceSequence(count) {
          // Generate english alphabet from A to Z.
          const referenceSequence = [];
          for (var i = 65, l = i + count; i < l; i++) {
            referenceSequence.push({
              title: String.fromCharCode(i),
              field: String.fromCharCode(i).toLowerCase(),
              colId: `col-${String.fromCharCode(i).toLowerCase()}`
            });
          }

          return referenceSequence;
        }

        _cellSelected(e) {
          debugger
          console.log(e);
        }
      }

      customElements.define(IncubatorSpreadsheetLight.is, IncubatorSpreadsheetLight);

      /**
       * @namespace Vaadin
       */
      window.Vaadin.IncubatorSpreadsheetLight = IncubatorSpreadsheetLight;

      if (window.Vaadin.runIfDevelopmentMode) {
        window.Vaadin.runIfDevelopmentMode('vaadin-license-checker', IncubatorSpreadsheetLight);
      }
    })();
  </script>
</dom-module>